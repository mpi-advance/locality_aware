#!/bin/sh
#Submit using flux batch <filename>

#flux: --job-name=gpuMemcpy_test_n2
#flux: --output='gpuMemcpy_test_n2.{{id}}.out'
#flux: --error='gpuMemcpy_test_n2.{{id}}.err'
#flux: -N 2
#flux: -l # Add task rank prefixes to each line of output.
#flux: --setattr=thp=always # Enable Transparent Huge Pages (THP)
#flux: -t 30

module load rocmcc/6.4.0-magic
module load cray-mpich/9.0.1

export ROCM_PATH=/usr/tce/packages/rocmcc/rocmcc-6.4.0-magic/

export MPICH_GPU_SUPPORT_ENABLED=1
export HSA_XNACK=1

# Check if THP are enabled
#cat /sys/kernel/mm/transparent_hugepage/enabled

cd $HOME/MPICCL/build/benchmarks

n_nodes=2
n_procs=2

flux run -N${n_nodes} -n${n_procs} -c1 --verbose --exclusive\
    --setopt=mpibind=verbose:2 ./gpuMemcpy_test
